#!/bin/sh

echo "Configuring TOME..."

if command -v python3 >/dev/null 2>&1; then
    PYTHON=python3
elif command -v python >/dev/null 2>&1; then
    PYTHON=python
else
    echo "Error: Python is not installed or not in your PATH."
    exit 1
fi

# Check Python version
PYTHON_VERSION=$(${PYTHON} -c 'import sys; print(".".join(map(str, sys.version_info[:2])))')
echo "Found Python $PYTHON_VERSION"

# Check pip
if ! command -v pip >/dev/null 2>&1; then
    echo "Error: pip is not installed."
    exit 1
fi
echo "Found pip: $(pip --version)"

# Check for pipreqs
if ! command -v pipreqs >/dev/null 2>&1; then
    echo "pipreqs not found, installing it now..."
    pip install --user pipreqs
    echo "Make sure your ~/.local/bin is in your PATH if 'pipreqs' can't be found."
fi
echo "Found pipreqs"

# Check if make is installed
if ! command -v make >/dev/null 2>&1; then
    echo "Error: 'make' is not installed. Please install it and try again."
    exit 1
fi
echo "Found make"

echo ""

if [ ! -d 'config' ]; then
    mkdir config

    read -p "Enter directory for database [$(pwd)/db]: " DATABASE_DIR
    DATABASE_DIR=${DATABASE_DIR:-$(pwd)/db}

    if [ ! -d $DATABASE_DIR ]; then mkdir $DATABASE_DIR 
    fi
    if [ ! -d "$DATABASE_DIR/backups" ]; then mkdir "$DATABASE_DIR/backups"
    fi

    DATABASE_DIR=$(echo $DATABASE_DIR | sed 's/\//\\\//g')
    cp defaults/TOME.toml config/
    sed -i "s/DB_DIR/$DATABASE_DIR/" config/TOME.toml

    for default in classes maps profanity races
    do
        read -p "Copy default $default? [Y/n] " COPY
        case $COPY in [yY][eE][sS]|[yY]|[jJ]|'')
            cp -r defaults/$default config/
        ;; *) mkdir config/$default
        esac
    done

    cp -r defaults/commands config/commands
else
    echo "Config directory already exists"
fi

echo ""

echo "All requirements for setup are present."

echo ""
echo "Now you can run:"
echo "  make install    # to set up the environment"
echo "  make run        # to start the MUD"
echo "  make clean      # to clear logs and caches"

exit 0
